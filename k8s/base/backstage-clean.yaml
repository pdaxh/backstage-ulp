apiVersion: v1
kind: Secret
metadata:
  name: backstage-secret
  namespace: backstage
type: Opaque
stringData:
  BACKEND_SECRET: dev-secret-please-change
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-app-config
  namespace: backstage
        data:
          app-config.local.yaml: |
            app:
              title: Backstage ULP
              baseUrl: http://localhost:7008
              support:
                url: https://github.com/pdaxh/backstage-ulp/issues
                items:
                  - title: Support
                    icon: help
                    links:
                      - url: https://github.com/pdaxh/backstage-ulp/issues
                        title: GitHub Issues

            organization:
              name: ULP

            backend:
              baseUrl: http://localhost:7008
              listen:
                port: 7008
              csp:
                connect-src: ["'self'", 'http:', 'https:']
              cors:
                origin: http://localhost:3000
                methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
                credentials: true
              database:
                client: pg
                connection:
                  host: postgres
                  port: 5432
                  user: backstage
                  password: backstage
                  database: backstage
              cache:
                store: memory


            proxy:
              '/prometheus':
                target: 'http://localhost:9090'
                changeOrigin: true

            techdocs:
              builder: 'local'
              generator:
                runIn: 'docker'
              publisher:
                type: 'local'

            scaffolder:
              defaultCommitMessage: 'chore: created {{cookiecutter.name}}'
              defaultAuthor:
                name: 'Backstage'
                email: 'backstage@ulp.com'

            auth:
              environment: development
              providers:
                guest: {}

            catalog:
              import:
                entityFilename: catalog-info.yaml
                pullRequestBranchName: backstage-integration
              rules:
                - allow: [Component, System, API, Resource, Domain, Group, User, Template, Location]
              locations:
                - type: file
                  target: /app/examples/entities.yaml
                - type: file
                  target: /app/examples/org.yaml
                - type: file
                  target: /app/examples/python-app.yaml
                - type: file
                  target: /app/examples/template/template.yaml

            permission:
              enabled: true
              policy:
                default: []
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage
  namespace: backstage
  labels:
    app: backstage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backstage
  template:
    metadata:
      labels:
        app: backstage
        app.kubernetes.io/name: backstage
        app.kubernetes.io/part-of: backstage-ulp
    spec:
      imagePullSecrets:
      - name: ghcr-secret
      containers:
      - name: backstage
        # Using the custom Backstage image
        image: ghcr.io/pdaxh/backstage-ulp:latest
        ports:
        - containerPort: 7008
          name: http
        env:
        - name: NODE_ENV
          value: "production"
        - name: POSTGRES_HOST
          value: "postgres"
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_USER
          value: "backstage"
        - name: POSTGRES_PASSWORD
          value: "backstage"
        - name: POSTGRES_DB
          value: "backstage"
        - name: APP_CONFIG
          value: "app-config.local.yaml"
        envFrom:
        - secretRef:
            name: backstage-secret
        volumeMounts:
        - name: app-config
          mountPath: /app/app-config.local.yaml
          subPath: app-config.local.yaml
        livenessProbe:
          httpGet:
            path: /healthz
            port: 7008
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: 7008
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
      volumes:
      - name: app-config
        configMap:
          name: backstage-app-config
---
apiVersion: v1
kind: Service
metadata:
  name: backstage
  namespace: backstage
  labels:
    app: backstage
spec:
  ports:
  - port: 80
    targetPort: 7008
    name: http
  selector:
    app: backstage
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: backstage
  namespace: backstage
  labels:
    app: backstage
spec:
  rules:
  - host: backstage.ulp.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backstage
            port:
              number: 80
