apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-secret-injector
  namespace: backstage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vault-secret-injector
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-secret-injector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vault-secret-injector
subjects:
- kind: ServiceAccount
  name: vault-secret-injector
  namespace: backstage
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-secret-injector
  namespace: backstage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault-secret-injector
  template:
    metadata:
      labels:
        app: vault-secret-injector
    spec:
      serviceAccountName: vault-secret-injector
      containers:
      - name: vault-secret-injector
        image: vault:1.15.2
        command: ["vault", "agent", "-config=/vault/config/vault-agent.hcl"]
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
        - name: vault-tokens
          mountPath: /vault/tokens
        env:
        - name: VAULT_ADDR
          value: "http://vault.vault.svc.cluster.local:8200"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-tokens
              key: backstage-token
      volumes:
      - name: vault-config
        configMap:
          name: vault-agent-config
      - name: vault-tokens
        secret:
          secretName: vault-tokens
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
  namespace: backstage
data:
  vault-agent.hcl: |
    vault {
      address = "http://vault.vault.svc.cluster.local:8200"
    }
    
    auto_auth {
      method "token" {
        config = {
          token_file = "/vault/tokens/backstage-token"
        }
      }
    }
    
    template {
      source = "/vault/config/backstage-secrets.tpl"
      destination = "/vault/secrets/backstage-secrets"
      perms = 0644
    }
    
    template {
      source = "/vault/config/database-secrets.tpl"
      destination = "/vault/secrets/database-secrets"
      perms = 0644
    }
    
  backstage-secrets.tpl: |
    {{ with secret "secret/data/backstage/app" }}
    BACKEND_SECRET={{ .Data.data.backend_secret }}
    FRONTEND_SECRET={{ .Data.data.frontend_secret }}
    SESSION_SECRET={{ .Data.data.session_secret }}
    {{ end }}
    
  database-secrets.tpl: |
    {{ with secret "secret/data/backstage/database" }}
    PGHOST={{ .Data.data.host }}
    PGPORT={{ .Data.data.port }}
    PGDATABASE={{ .Data.data.database }}
    PGUSER={{ .Data.data.username }}
    PGPASSWORD={{ .Data.data.password }}
    {{ end }}
